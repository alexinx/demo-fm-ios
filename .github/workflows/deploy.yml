name: Deploy to CocoaPods

on:
  push:
    tags:
      - "v[0-9]+.[0-9]+.[0-9]+"

jobs:
  deploy-cocoapods:
    name: Deploy to CocoaPods
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - uses: maxim-lobanov/setup-xcode@v1
        with: { xcode-version: "16.4" }

      - run: sudo xcode-select -s /Applications/Xcode.app
      - run: xcodebuild -version

      - uses: ruby/setup-ruby@v1
        with: { ruby-version: "3.1" }

      - run: gem install cocoapods

      - id: tag_version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - run: cd Example && pod install --repo-update

      - run: chmod +x build-universal-framework.sh && bash build-universal-framework.sh

      - run: |
          cd lib
          swift build
          echo "✓ Swift build passed"

      # Safe version update from tag version to podspec
      - run: |
          cd lib
          TAG_VERSION="${{ steps.tag_version.outputs.version }}"
          sed -i '' "s/\(s\.version[[:space:]]*=[[:space:]]*\)'.*'/\1'$TAG_VERSION'/" DemoAlexSDK.podspec

      - run: cd lib && pod lib lint DemoAlexSDK.podspec --allow-warnings --verbose

      # ✅ Push to PUBLIC repo first before pushing to CocoaPods
      - name: Push to public repo
        env:
          GH_TOKEN: ${{ secrets.CYPHLENS_IOS_SSE_SDK_WRITE }}
        run: |
          TAG="v${{ steps.tag_version.outputs.version }}"
          git clone https://x-access-token:$GH_TOKEN@github.com/alexinx/demo-fm-ios-doc.git /tmp/public
          cd /tmp/public

          rm -rf Frameworks Package.swift DemoAlexSDK.podspec LICENSE README.md
          mkdir Frameworks
          cp -R $GITHUB_WORKSPACE/lib/Frameworks/DemoAlexSDK.xcframework Frameworks/
          cp $GITHUB_WORKSPACE/lib/Package.swift .
          cp $GITHUB_WORKSPACE/lib/DemoAlexSDK.podspec .
          cp $GITHUB_WORKSPACE/lib/LICENSE .
          cp $GITHUB_WORKSPACE/lib/README.md .

          git config user.name "alex-bot"
          git config user.email "devops@alex.com"
          git add .
          git commit -m "Release $TAG" || echo "No changes"
          git tag $TAG || echo "Tag exists"
          git push origin $TAG

      # ✅ Push to CocoaPods
      - name: Deploy to CocoaPods Trunk
        env:
          COCOAPODS_TRUNK_TOKEN: ${{ secrets.COCOAPODS_TRUNK_TOKEN }}
        run: cd lib && pod trunk push DemoAlexSDK.podspec --allow-warnings --verbose

      - run: echo "✅ Release ${{ steps.tag_version.outputs.version }} published successfully"

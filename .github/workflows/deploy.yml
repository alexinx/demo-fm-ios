name: Deploy to CocoaPods

on:
  push:
    tags:
      - "v[0-9]+.[0-9]+.[0-9]+"

jobs:
  validate-package:
    name: Validate Swift Package
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - uses: maxim-lobanov/setup-xcode@v1
        with: { xcode-version: "16.4" }

      - run: sudo xcode-select -s /Applications/Xcode.app
      - run: xcodebuild -version

      - if: hashFiles('Package.swift') != ''
        run: swift package resolve
      - if: hashFiles('Package.swift') != ''
        run: swift build
      - if: hashFiles('Package.swift') != ''
        run: swift package describe --type json > /dev/null

  deploy-cocoapods:
    name: Deploy to CocoaPods
    runs-on: macos-latest
    needs: [validate-package]
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - uses: maxim-lobanov/setup-xcode@v1
        with: { xcode-version: "16.4" }

      - run: sudo xcode-select -s /Applications/Xcode.app
      - run: xcodebuild -version

      - uses: ruby/setup-ruby@v1
        with: { ruby-version: "3.1" }

      - run: gem install cocoapods

      - id: tag_version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - run: cd Example && pod install --repo-update
      - run: chmod +x build-universal-framework.sh && bash build-universal-framework.sh

      # Safe version update
      - run: |
          cd lib
          TAG_VERSION="${{ steps.tag_version.outputs.version }}"
          sed -i '' "s/\(s\.version[[:space:]]*=[[:space:]]*\)'.*'/\1'$TAG_VERSION'/" DemoAlexSDK.podspec

      - run: cd lib && pod lib lint DemoAlexSDK.podspec --allow-warnings --verbose

      # Push to public repo
      - name: Push to public repo
        if: false
        env:
          GH_TOKEN: ${{ secrets.CYPHLENS_IOS_SSE_SDK_WRITE }}
        run: |
          TAG="v${{ steps.tag_version.outputs.version }}"
          git clone https://x-access-token:$GH_TOKEN@github.com/cyphlens/cyphlens-ios-sse-sdk.git /tmp/public
          cd /tmp/public

          rm -rf Frameworks Package.swift DemoAlexSDK.podspec LICENSE README.md
          mkdir Frameworks
          cp -R $GITHUB_WORKSPACE/lib/Frameworks/DemoAlexSDK.xcframework Frameworks/
          cp $GITHUB_WORKSPACE/lib/Package.swift .
          cp $GITHUB_WORKSPACE/lib/DemoAlexSDK.podspec .
          cp $GITHUB_WORKSPACE/lib/LICENSE .
          cp $GITHUB_WORKSPACE/lib/README.md .

          git config user.name "cyphlens-bot"
          git config user.email "devops@cyphlens.com"
          git add .
          git commit -m "Release $TAG" || echo "No changes"
          git tag $TAG || echo "Tag exists"
          git push origin $TAG

      # Push to CocoaPods
      - name: Deploy to CocoaPods Trunk
        env:
          COCOAPODS_TRUNK_TOKEN: ${{ secrets.COCOAPODS_TRUNK_TOKEN }}
        run: cd lib && pod trunk push DemoAlexSDK.podspec --allow-warnings --verbose

      - run: echo "âœ… Release ${{ steps.tag_version.outputs.version }} published successfully"

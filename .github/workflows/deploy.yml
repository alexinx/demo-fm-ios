name: Deploy to CocoaPods

on:
  push:
    tags:
      - "v[0-9]+.[0-9]+.[0-9]+" # Matches v1.0.1, v1.0.0, v10.20.30, etc.

jobs:
  validate-package:
    name: Validate Swift Package
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - uses: maxim-lobanov/setup-xcode@v1
        with: { xcode-version: "16.4" }

      - run: sudo xcode-select -s /Applications/Xcode.app
      - run: xcodebuild -version

      - if: hashFiles('Package.swift') != ''
        run: swift package resolve

      - if: hashFiles('Package.swift') != ''
        run: swift build

      - if: hashFiles('Package.swift') != ''
        run: swift package describe --type json > /dev/null

  validate-podspec:
    name: Validate Podspec
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - uses: maxim-lobanov/setup-xcode@v1
        with: { xcode-version: "16.4" }

      - run: sudo xcode-select -s /Applications/Xcode.app
      - run: xcodebuild -version

      - uses: ruby/setup-ruby@v1
        with: { ruby-version: "3.1" }

      - run: gem install cocoapods

      - id: tag_version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - run: |
          PODSPEC_VERSION=$(grep -E "s\.version\s*=" DemoSDK.podspec | sed -E "s/.*['\"](.*)['\"].*/\1/")
          [ "$PODSPEC_VERSION" = "${{ steps.tag_version.outputs.version }}" ]

      - run: pod lib lint DemoSDK.podspec --allow-warnings --verbose

  deploy-cocoapods:
    name: Deploy to CocoaPods
    runs-on: macos-latest
    needs: [validate-package, validate-podspec]
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - uses: maxim-lobanov/setup-xcode@v1
        with: { xcode-version: "16.4" }

      - run: sudo xcode-select -s /Applications/Xcode.app
      - run: xcodebuild -version

      - uses: ruby/setup-ruby@v1
        with: { ruby-version: "3.1" }

      - run: gem install cocoapods

      - id: tag_version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - run: cd Example && pod install --repo-update

      - run: chmod +x build-universal-framework.sh && bash build-universal-framework.sh

      - run: |
          TAG_VERSION="${{ steps.tag_version.outputs.version }}"
          sed -i '' "s/s\.version.*/s.version = '$TAG_VERSION'/" lib/DemoSDK.podspec

      - run: cd lib && pod lib lint DemoSDK.podspec --allow-warnings --verbose

      # ✅ Push to PUBLIC repo FIRST
      - name: Push to public repo
        env:
          GH_TOKEN: ${{ secrets.CYPHLENS_IOS_SSE_SDK_WRITE }}
        run: |
          TAG="v${{ steps.tag_version.outputs.version }}"
          git clone https://x-access-token:$GH_TOKEN@github.com/cyphlens/cyphlens-ios-sse-sdk.git /tmp/public
          cd /tmp/public

          rm -rf Frameworks Package.swift DemoSDK.podspec LICENSE README.md
          mkdir Frameworks
          cp -R $GITHUB_WORKSPACE/lib/Frameworks/DemoSDK.xcframework Frameworks/
          cp $GITHUB_WORKSPACE/lib/Package.swift .
          cp $GITHUB_WORKSPACE/lib/DemoSDK.podspec .
          cp $GITHUB_WORKSPACE/lib/LICENSE .
          cp $GITHUB_WORKSPACE/lib/README.md .

          git config user.name "cyphlens-bot"
          git config user.email "devops@cyphlens.com"
          git add .
          git commit -m "Release $TAG" || echo "No changes"
          git tag $TAG || echo "Tag exists"
          git push origin $TAG

      # ✅ THEN push to CocoaPods
      - name: Deploy to CocoaPods Trunk
        env:
          COCOAPODS_TRUNK_TOKEN: ${{ secrets.COCOAPODS_TRUNK_TOKEN }}
        run: cd lib && pod trunk push DemoSDK.podspec --allow-warnings --verbose

      - run: echo "✅ Release ${{ steps.tag_version.outputs.version }} published successfully"
